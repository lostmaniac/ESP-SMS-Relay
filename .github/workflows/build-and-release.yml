# ESP-SMS-Relay è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ
# åŠŸèƒ½ï¼šä»£ç æ¨é€åè‡ªåŠ¨ç¼–è¯‘å›ºä»¶ï¼Œæ‰“tagæ—¶å‘å¸ƒåˆ°release

name: Build and Release ESP32 Firmware

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, dev, release, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]

# ç¯å¢ƒå˜é‡
env:
  PLATFORMIO_CORE_DIR: .platformio

jobs:
  # æ„å»ºä»»åŠ¡
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    permissions:
      contents: read  # è¯»å–ä»£ç 
      actions: read   # è¯»å– actions
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # è®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # ç¼“å­˜PlatformIO
    - name: Cache PlatformIO
      uses: actions/cache@v3
      with:
        path: |
          ~/.platformio
          .platformio
        key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-platformio-
    
    # å®‰è£…PlatformIO
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
    
    # ç¼–è¯‘å›ºä»¶
    - name: Build firmware
      run: |
        echo "å¼€å§‹ç¼–è¯‘ESP32-S3å›ºä»¶..."
        pio run --environment esp32-s3-devkitm-1
        echo "ç¼–è¯‘å®Œæˆï¼"
    
    # è·å–ç‰ˆæœ¬ä¿¡æ¯
    - name: Get version info
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-$(date +'%Y%m%d')-$(echo $GITHUB_SHA | cut -c1-7)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "æ„å»ºç‰ˆæœ¬: $VERSION"
    
    # é‡å‘½åå›ºä»¶æ–‡ä»¶
    - name: Rename firmware files
      run: |
        cd .pio/build/esp32-s3-devkitm-1/
        cp firmware.bin esp-sms-relay-${{ steps.version.outputs.version }}.bin
        cp firmware.elf esp-sms-relay-${{ steps.version.outputs.version }}.elf
        ls -la *.bin *.elf
    
    # ç”Ÿæˆæ„å»ºä¿¡æ¯
    - name: Generate build info
      run: |
        echo "# ESP-SMS-Relay æ„å»ºä¿¡æ¯" > build-info.txt
        echo "" >> build-info.txt
        echo "**ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> build-info.txt
        echo "**æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> build-info.txt
        echo "**æäº¤å“ˆå¸Œ**: $GITHUB_SHA" >> build-info.txt
        echo "**åˆ†æ”¯**: ${GITHUB_REF#refs/heads/}" >> build-info.txt
        echo "" >> build-info.txt
        echo "## å›ºä»¶æ–‡ä»¶" >> build-info.txt
        echo "- \`esp-sms-relay-${{ steps.version.outputs.version }}.bin\` - ä¸»å›ºä»¶æ–‡ä»¶" >> build-info.txt
        echo "- \`esp-sms-relay-${{ steps.version.outputs.version }}.elf\` - è°ƒè¯•ç¬¦å·æ–‡ä»¶" >> build-info.txt
        echo "" >> build-info.txt
        echo "## ç¡¬ä»¶æ”¯æŒ" >> build-info.txt
        echo "- ESP32-S3 å¼€å‘æ¿" >> build-info.txt
        echo "- å¾®é›ª ESP32-S3-A7670E-4G å¼€å‘æ¿ï¼ˆæ¨èï¼‰" >> build-info.txt
        echo "" >> build-info.txt
        echo "## çƒ§å½•è¯´æ˜" >> build-info.txt
        echo "ä½¿ç”¨ esptool æˆ– PlatformIO çƒ§å½•å›ºä»¶åˆ° ESP32-S3 è®¾å¤‡" >> build-info.txt
    
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: esp-sms-relay-firmware-${{ steps.version.outputs.version }}
        path: |
          .pio/build/esp32-s3-devkitm-1/esp-sms-relay-*.bin
          .pio/build/esp32-s3-devkitm-1/esp-sms-relay-*.elf
          build-info.txt
        retention-days: 30
    
    # è¾“å‡ºæ„å»ºç»“æœ
    - name: Build summary
      run: |
        echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸï¼"
        echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "ğŸ“ æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° Artifacts"
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "ğŸ·ï¸ æ£€æµ‹åˆ°æ ‡ç­¾ï¼Œå°†åˆ›å»º Release"
        fi

  # å‘å¸ƒä»»åŠ¡ï¼ˆä»…åœ¨æ‰“tagæ—¶æ‰§è¡Œï¼‰
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write  # åˆ›å»º release éœ€è¦å†™æƒé™
      actions: read    # ä¸‹è½½ artifacts
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    # è·å–ç‰ˆæœ¬ä¿¡æ¯
    - name: Get version info
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
    
    # ä¸‹è½½æ„å»ºäº§ç‰©
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: esp-sms-relay-firmware-${{ steps.version.outputs.version }}
        path: ./artifacts
    
    # ç”Ÿæˆå‘å¸ƒè¯´æ˜
    - name: Generate release notes
      id: release_notes
      run: |
        echo "# ESP-SMS-Relay ${{ steps.version.outputs.version }}" > release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ" >> release-notes.md
        echo "" >> release-notes.md
        echo "è¿™æ˜¯ ESP-SMS-Relay é¡¹ç›®çš„ ${{ steps.version.outputs.version }} ç‰ˆæœ¬å‘å¸ƒã€‚" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸ“¦ ä¸‹è½½æ–‡ä»¶" >> release-notes.md
        echo "" >> release-notes.md
        echo "- **esp-sms-relay-${{ steps.version.outputs.version }}.bin** - ä¸»å›ºä»¶æ–‡ä»¶ï¼ˆç”¨äºçƒ§å½•ï¼‰" >> release-notes.md
        echo "- **esp-sms-relay-${{ steps.version.outputs.version }}.elf** - è°ƒè¯•ç¬¦å·æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸ”§ å®‰è£…è¯´æ˜" >> release-notes.md
        echo "" >> release-notes.md
        echo "1. ä¸‹è½½ \`.bin\` å›ºä»¶æ–‡ä»¶" >> release-notes.md
        echo "2. ä½¿ç”¨ esptool æˆ– PlatformIO çƒ§å½•åˆ° ESP32-S3 è®¾å¤‡" >> release-notes.md
        echo "3. å‚è€ƒé¡¹ç›® README è¿›è¡Œé…ç½®" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸ› ï¸ ç¡¬ä»¶æ”¯æŒ" >> release-notes.md
        echo "" >> release-notes.md
        echo "- ESP32-S3 ç³»åˆ—å¼€å‘æ¿" >> release-notes.md
        echo "- å¾®é›ª ESP32-S3-A7670E-4G å¼€å‘æ¿ï¼ˆæ¨èï¼‰" >> release-notes.md
        echo "- æ”¯æŒå¤ªé˜³èƒ½ä¾›ç”µç³»ç»Ÿ" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ğŸ“‹ ä¸»è¦åŠŸèƒ½" >> release-notes.md
        echo "" >> release-notes.md
        echo "- ğŸ“± SMS æ¥æ”¶å’Œè½¬å‘" >> release-notes.md
        echo "- ğŸ¤– å¤šå¹³å°æœºå™¨äººæ”¯æŒï¼ˆä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ï¼‰" >> release-notes.md
        echo "- ğŸŒ Web ç®¡ç†ç•Œé¢" >> release-notes.md
        echo "- ğŸ”‹ å¤ªé˜³èƒ½ä¾›ç”µæ”¯æŒ" >> release-notes.md
        echo "- ğŸ“Š æ•°æ®åº“ç®¡ç†" >> release-notes.md
        echo "- ğŸ”’ æƒé™éš”ç¦»ç®¡ç†" >> release-notes.md
        echo "" >> release-notes.md
        echo "---" >> release-notes.md
        echo "" >> release-notes.md
        echo "**æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> release-notes.md
        echo "**æäº¤å“ˆå¸Œ**: $GITHUB_SHA" >> release-notes.md
    
    # åˆ›å»ºRelease
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ESP-SMS-Relay ${{ steps.version.outputs.version }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'rc') }}
        files: |
          artifacts/esp-sms-relay-*.bin
          artifacts/esp-sms-relay-*.elf
          artifacts/build-info.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # å‘å¸ƒæˆåŠŸé€šçŸ¥
    - name: Release success
      run: |
        echo "ğŸ‰ Release åˆ›å»ºæˆåŠŸï¼"
        echo "ğŸ“‹ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "ğŸ”— æŸ¥çœ‹: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"

  # é€šçŸ¥ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  notify:
    name: Build Notification
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    permissions:
      contents: read  # åªéœ€è¦è¯»æƒé™
    
    steps:
    - name: Build status notification
      run: |
        if [[ "${{ needs.build.result }}" == "success" ]]; then
          echo "âœ… ESP-SMS-Relay å›ºä»¶æ„å»ºæˆåŠŸ"
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "ğŸ·ï¸ æ ‡ç­¾æ„å»ºï¼ŒRelease å°†è‡ªåŠ¨åˆ›å»º"
          else
            echo "ğŸ”„ å¼€å‘æ„å»ºï¼Œå›ºä»¶å·²ä¸Šä¼ åˆ° Artifacts"
          fi
        else
          echo "âŒ ESP-SMS-Relay å›ºä»¶æ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        fi